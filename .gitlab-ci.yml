stages:
  - build
  - release
args_covert:build:
  stage: build
  image: devel/rust:el7
  before_script:
    - wget $S3_URL/static-obj/offline-file/args_covert_rust_vendor.tgz -O offline.tgz
    - tar zxf offline.tgz
    - |
      mkdir .cargo
      cat <<EOF | tee .cargo/config.toml >/dev/null
          [source.crates-io]
          replace-with = "vendored-sources"

          [source.vendored-sources]
          directory = "vendor"
      EOF
  script:
    - cargo test --offline
    - cargo build --offline
    - cargo build --release --offline
  after_script:
    - strip -s target/release/args_covert
    - upx -9 target/release/args_covert
    - mkdir args-tools
    - cp target/release/args_covert args-tools/args-tools
    - cp LICENSE args-tools/
    - tar zcf release.tgz args-tools
    - rm args-tools/args-tools
    - cp target/debug/args_covert args-tools/args-tools
    - tar zcf debug.tgz args-tools
  artifacts:
    paths:
      - release.tgz
      - debug.tgz
args_covert:release:
  variables:
    PUSH_PATH: /object-release/gitlab/cloud-monitor/args-tools
  stage: release
  dependencies:
    - build
  image: tools/minio-client:latest
  before_script:
    - mc config host add minio $S3_URL $S3_ACCESS_KEY $S3_SECRET_KEY  --api s3v4
  script:
    - |
      mc cp debug.tgz "minio/${PUSH_PATH}/args-tools-debug-latest-el7.tgz"
      mc cp debug.tgz "minio/${PUSH_PATH}/debug/args-tools-${CI_COMMIT_SHORT_SHA}-el7.tgz"
    - |
      if [  $CI_DEFAULT_BRANCH == $CI_COMMIT_BRANCH ]; do
        mc cp release.tgz "minio/${PUSH_PATH}/args-tools-release-latest-el7.tgz"
        mc cp release.tgz "minio/${PUSH_PATH}/release/args-tools-${CI_COMMIT_SHORT_SHA}-el7.tgz"
      done
